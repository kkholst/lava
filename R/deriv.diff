2c2,4
< deriv.lvm <- function(x, p, mom, cond=FALSE, meanpar=TRUE, mu=NULL, S=NULL, second=FALSE, zeroones=FALSE, all=FALSE,...) {   
---
> deriv.lvm <- function(x, p, mom, cond=FALSE, meanpar=TRUE, mu=NULL, S=NULL, second=FALSE, zeroones=FALSE,...) {
> 
>   all <- TRUE
4a7,8
>   } else {
>     all <- FALSE
6d9
<   
9c12,18
<   npar.mean <- ii$npar.mean
---
>   npar.mean <- ifelse(is.null(meanpar),0,ii$npar.mean)
>   if (npar.mean>0) {
>     meanpar <- 1:npar.mean
>   } else {
>     meanpar <- NULL
>   }  
>   ##  npar.mean <- ii$npar.mean
12c21
<     nn <- matrices(x,1:npar + npar.mean,1:npar.mean);  
---
>     nn <- matrices(x,1:npar + npar.mean,meanpar);
17,20c26
<   Apar <- t(nn$A)
<   ##  Par <- Apar + nn$P  
<   Mean <- nn$v;
<   ##Mean[ii$v0!=1] <- 0
---
>   ##  Apar <- t(nn$A)
37c43
<   
---
> 
39c45
<     dimA <- length(Apar)
---
>     dimA <- length(nn$A)
47c53
<       dA[,regr.idx] <- sapply(regr.idx, function(i) izero(which(Apar==i),nrow(dA)) )
---
>       dA[,regr.idx] <- sapply(regr.idx, function(i) izero(which(t(nn$A)==i),nrow(dA)) )
62c68
<       dv[,mean.idx] <- sapply(1:npar.mean, function(i) izero(which(Mean==i),length(x$mean)) ) 
---
>       dv[,mean.idx] <- sapply(1:npar.mean, function(i) izero(which(nn$v==i),length(x$mean)) ) 
65d70
<     if (!all) return(res)
67c72
<     res <- with(ii, list(dA=dA, dP=dP, dv=dv))
---
>     res <- with(ii, list(dA=dA, dP=dP, dv=dv))    
69c74,76
<  
---
>   if (!all)
>     return(res)
>   
71c78
<   if (!missing(p)) {
---
>   if (!missing(p) && length(index(x)$constrain.par)>0) {
88c95
<           ii$dP[mat.idx$cov.idx,allpars] <- Gr[jj]
---
>           res$dP[mat.idx$cov.idx,allpars] <- Gr[jj]
90c97
<           ii$dA[mat.idx$reg.tidx,allpars] <- Gr[jj]
---
>           res$dA[mat.idx$reg.tidx,allpars] <- Gr[jj]
92c99
<           ii$dv[mat.idx$m.idx,allpars] <- Gr[jj]
---
>           res$dv[mat.idx$m.idx,allpars] <- Gr[jj]
95c102
<     res <- with(ii, list(dA=dA, dP=dP, dv=dv))
---
>     ##    res <- with(ii, list(dA=dA, dP=dP, dv=dv))
98c105,106
<   dG <- suppressMessages(with(mom, (t(IAi) %x% G) %*% (ii$dA)))  
---
>   
>   dG <- suppressMessages(with(mom, (t(IAi) %x% G) %*% (res$dA)))  
102c110
<   G3 <- with(mom, (G%x%G)%*%(ii$dP))
---
>   G3 <- with(mom, (G%x%G)%*%(res$dP))
110c118
<              G%*%ii$dv)                      
---
>              G%*%res$dv)                      
121c129
<       k <- nrow(ii$A)
---
>       k <- nrow(res$A)
